---
name: stable release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: tagger stable release
    runs-on: ubuntu-latest
    steps:
      - name: checkout source code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: build linux plugin
        run: make kubectl-tag

      - name: compress linux plugin
        run: tar -C _output/bin -czvf kubectl-tag-linux-amd64.tgz kubectl-tag

      - name: build darwin plugin
        run: make kubectl-tag-darwin

      - name: compress darwin plugin
        run: tar -C _output/bin -czvf kubectl-tag-darwin-amd64.tgz kubectl-tag

      - name: extract current tag
        id: get_tag
        run: echo ::set-output name=tag::$(echo $GITHUB_REF | cut -d / -f 3)

      - name: prepare helm chart release
        run: sed -i 's/RELEASE/${{ steps.get_tag.outputs.tag }}/g' assets/helm-chart/values.yaml

      - name: build helm chart release
        run: tar -C assets -czvf helm-chart.tgz helm-chart

      - name: publish release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          files: |
            helm-chart.tgz
            kubectl-tag-linux-amd64.tgz
            kubectl-tag-darwin-amd64.tgz
            README.md
